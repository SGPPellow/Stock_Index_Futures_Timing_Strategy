<!DOCTYPE html>
<html>

<head>
  <title>股指择时策略</title>
  <script src="https://cdn.plot.ly/plotly-3.1.0-rc.1.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    select {
      padding: 12px 20px;
      font-size: 18px;
      font-family: 'system-ui';
      border-radius: 8px;
      background-color: white;
      color: #333;
      cursor: pointer;
      outline: none;
      transition: all 0.3s ease;
      width: auto;
      margin-left: 15px;
    }

    select:focus {
      border-color: #1f77b4;
      box-shadow: 0 0 8px rgba(52, 178, 161, 0.5);
    }

    select:hover {
      border-color: #1f77b4;
    }

    #plot {
      width: 2500px;
      height: 1000px;
      margin: 0 0 0 0;
      padding: 10px;
      border-radius: 16px;
      background-color: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <!-- <input type="file" id="fileInput" accept=".csv" /> -->
  <h2 style="font-family: system-ui; margin-left: 15px;">股指择时策略</h2>
  <select id="strategy_select">
    <option value="1">动量因子风格择时信号</option>
    <option value="2">拥挤度动量因子风格择时信号</option>
    <option value="3">相对强弱动量因子风格择时信号(大盘价值指数和小盘成长指数)</option>
    <option value="4">相对强弱动量因子风格择时信号(沪深300指数和中证1000指数)</option>
    <option value="5">多维动量复合风格择时对冲信号</option>
  </select>

  <select id="year_select">
    <option value="All">All</option>
    <option value="2010">2010</option>
    <option value="2011">2011</option>
    <option value="2012">2012</option>
    <option value="2013">2013</option>
    <option value="2014">2014</option>
    <option value="2015">2015</option>
    <option value="2016">2016</option>
    <option value="2017">2017</option>
    <option value="2018">2018</option>
    <option value="2019">2019</option>
    <option value="2020">2020</option>
    <option value="2021">2021</option>
    <option value="2022">2022</option>
    <option value="2023">2023</option>
    <option value="2024">2024</option>
    <option value="2025">2025</option>
  </select>
  <div id="plot">
    <div id="metricsTableContainer" style="position: absolute; top: 140px; left: 15px; z-index: 10;"></div>
  </div>

  <script>
    let csvdata = [];
    // document.getElementById("fileInput").addEventListener("change", function (event) {
    //   const file = event.target.files[0];  // Get the first file selected
    //   if (file) {
    //     const reader = new FileReader();  // Create a new FileReader
    //     reader.onload = function (e) {
    //       const csvdata = e.target.result;  // Get the file content as text
    //       // console.log("Raw CSV Data:", csvdata)
    //       csvdata = d3.csvParse(csvdata);  // Parse CSV using D3
    //       console.log("Parsed Data:", csvdata);
    //       plotStrategy(1, 'All');
    //     };
    //     reader.readAsText(file);  // Read the file as text
    //   }
    // });


    d3.csv("https://raw.githubusercontent.com/SGPPellow/Stock_Index_Futures_Timing_Strategy/refs/heads/main/output.csv", function (d) {
      return {
        date: d.date,
        Signal1_day_rtn: +d.Signal1_day_rtn,
        Position1: d.Position1,
        Signal2_day_rtn: +d.Signal2_day_rtn,
        Position2: d.Position2,
        Signal3_day_rtn: +d.Signal3_day_rtn,
        Position3: d.Position3,
        Signal4_day_rtn: +d.Signal4_day_rtn,
        Position4: d.Position4,
        Signal5_day_rtn: +d.Signal5_day_rtn,
        Position5: d.Position5
      }
    })
      .then(function (data) {
        csvdata = data;
        plotStrategy(1, 'All');
      })

    function plotStrategy(n, year) {

      calculatePerformanceMetrics(n, year);

      // const filteredData = year === 'All'
      //   ? csvdata
      //   : csvdata.filter(row => row.date.startsWith(year));

      var sampleData;
      if (year === 'All') {
        sampleData = csvdata;
      } else {
        sampleData = csvdata.filter(row => row.date.startsWith(year));
      }
      let c1 = 500000, c2 = 500000, c3 = 500000, c4 = 500000, c5 = 500000;
      sampleData.forEach(d => {
        c1 *= d.Signal1_day_rtn;
        c2 *= d.Signal2_day_rtn;
        c3 *= d.Signal3_day_rtn;
        c4 *= d.Signal4_day_rtn;
        c5 *= d.Signal5_day_rtn;
        d.Signal1_cum_value = c1;
        d.Signal2_cum_value = c2;
        d.Signal3_cum_value = c3;
        d.Signal4_cum_value = c4;
        d.Signal5_cum_value = c5;
      });

      // } else if (year === '2010') {
      //   sampleData = csvdata.filter(row => row.date.startsWith(year));
      // } else {
      //   lastDayOfPreviousYear = getLastTradingDay(year - 1);
      //   lastDayOfCurrentYear = getLastTradingDay(year);
      //   sampleData = csvdata.filter(row => row.date >= lastDayOfPreviousYear && row.date <= lastDayOfCurrentYear).map(row => ({ ...row }));
      //   scaleSignalColumnsToStartAt500k(sampleData, n);
      // }

      const x = sampleData.map(row => row.date)
      const y = sampleData.map(row => +row[`Signal${n}_cum_value`])
      const position = sampleData.map(row => row[`Position${n}`])

      const trace = {
        x: x,
        y: y,
        mode: 'lines',
        name: '',
        text: position,
        line: {
          color: '#1f77b4',
          width: 6
        },
        hovertemplate: '<b>Date</b>: %{x|%Y-%m-%d}<br>' + '<b>Value</b>: %{y}<br>' + '<b>Position</b>: %{text}'
      }

      const layout = {
        title: { text: '' },
        xaxis: {
          type: 'date'
        },
        xaxis: {
          type: 'date'
        },
        yaxis: {
          tickformat: ",.0f"
        },
        hoverlabel: {
          align: 'left',
          font: {
            size: 18,
          }
        }
      };

      Plotly.newPlot('plot', [trace], layout);

    }

    function calculatePerformanceMetrics(n, year) {

      // var sampleData;
      // var startDate;
      // if (year === 'All') {
      //   sampleData = csvdata;
      //   startValue = 500000;
      //   startDate = sampleData[0]['date'];
      // } else if (year === '2010') {
      //   sampleData = csvdata.filter(row => row.date.startsWith(year));
      //   startValue = 500000;
      //   startDate = sampleData[0]['date'];
      // } else {
      //   lastDayOfPreviousYear = getLastTradingDay(year - 1);
      //   lastDayOfCurrentYear = getLastTradingDay(year);
      //   sampleData = csvdata.filter(row => row.date >= lastDayOfPreviousYear && row.date <= lastDayOfCurrentYear);
      //   startValue = sampleData[0][`Signal${n}_Value`];
      //   startDate = getFirstTradingDay(year);
      // }
      var startValue = 500000;
      var sampleData;
      var startDate;
      if (year === 'All') {
        sampleData = csvdata;
      } else {
        sampleData = csvdata.filter(row => row.date.startsWith(year));
      }
      console.log(sampleData)
      startDate = sampleData[0]['date'];
      console.log(startDate)
      var endDate = sampleData[sampleData.length - 1]['date'];
      var endValue = sampleData[sampleData.length - 1][[`Signal${n}_cum_value`]]
      var returnPercentage = ((endValue - startValue) / startValue) * 100;
      var annualReturn = ((endValue / startValue) ** (250 / sampleData.length) - 1) * 100;
      console.log(sampleData[sampleData.length - 1])
      let peak = startValue;
      var peakTime = 0;
      var allPeakTime = 0;
      var allLowTime = 0;
      let maxDrawdown = 0;

      for (let i = 1; i < sampleData.length; i++) {
        if (sampleData[i][`Signal${n}_cum_value`] > peak) {
          peak = sampleData[i][`Signal${n}_cum_value`];
          peakTime = sampleData[i]['date'];
        } else {
          const drawdown = (peak - sampleData[i][`Signal${n}_cum_value`]) / peak * 100;
          if (drawdown > maxDrawdown) {
            maxDrawdown = drawdown;
            allPeakTime = peakTime;
            allLowTime = sampleData[i]['date'];
          }
        }
      }

      // let tableHTML;
      // if (year === 'All') {
      //   tableHTML = `
      //     <table style=" border-collapse: collapse; background-color: white; font-size: 20px; width: 150%;">
      //       <tbody>
      //         <tr>
      //           <td style="padding: 10px; padding-right: 60px;"><b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}</td>
      //           <td style="padding: 10px; padding-right: 60px;"><b>期初资金</b>:&nbsp&nbsp${startValue.toFixed(0)}</td>
      //           <td style="padding: 10px; padding-right: 60px;"><b>期末资金</b>:&nbsp&nbsp${endValue.toFixed(0)}</td>
      //           <td style="padding: 10px; padding-right: 60px;"><b>净资金变动</b>:&nbsp&nbsp${(endValue - startValue).toFixed(0)} </td>
      //         </tr>
      //         <tr>
      //           <td style="padding: 10px;"><b>累计收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%</td>  
      //           <td style="padding: 10px;"><b>年化收益率</b>:&nbsp&nbsp${annualReturn.toFixed(2)}%</td>
      //           <td style="padding: 10px;"><b>最大回撤</b>:&nbsp&nbsp${maxDrawdown.toFixed(2)}%</td>
      //           <td style="padding: 10px;"><b>最大回撤发生时间</b>:&nbsp&nbsp${allPeakTime} ~ ${allLowTime}</td>
      //         </tr>
      //       </tbody>
      //     </table>
      //   `;
      // } else {
      //   tableHTML = `
      //     <table style=" border-collapse: collapse; background-color: white; font-size: 20px; width: 150%;">
      //       <tbody>
      //         <tr>
      //           <td style="padding: 10px;"><b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}</td>
      //           <td style="padding: 10px;"><b>期初资金</b>:&nbsp&nbsp${startValue.toFixed(0)}</td>
      //           <td style="padding: 10px;"><b>期末资金</b>:&nbsp&nbsp${endValue.toFixed(0)}</td>
      //           <td style="padding: 10px;"><b>净资金变动</b>:&nbsp&nbsp${(endValue - startValue).toFixed(0)} </td>
      //         </tr>
      //         <tr> 
      //           <td style="padding: 10px;"><b>年化收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%</td>
      //           <td style="padding: 10px;"><b>最大回撤</b>:&nbsp&nbsp${maxDrawdown.toFixed(2)}%</td>
      //           <td style="padding: 10px;"><b>最大回撤发生时间</b>:&nbsp&nbsp${allPeakTime} ~ ${allLowTime}</td>
      //         </tr>
      //       </tbody>
      //     </table>
      //   `;
      // }

      // document.getElementById('metricsTableContainer').innerHTML = tableHTML;
      // if (year === 'All') {
      //   document.getElementById('return').innerHTML = `<b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}<span id="space1"></span><b>收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%<span id="space2"></span><b>年化收益率</b>:&nbsp&nbsp${annualReturn.toFixed(2)}%`;
      // } else {
      //   document.getElementById('return').innerHTML = `<b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}<span id="space1"></span><b>收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%`;
      // }
      // document.getElementById('max_Drawdown').innerHTML = `<b>最大回撤</b>: &nbsp&nbsp${maxDrawdown.toFixed(2)}%<span id="space2"></span><b>最大回撤发生时间:</b>&nbsp&nbsp${allPeakTime} ~ ${allLowTime}`;
    }

    function getFirstTradingDay(year) {
      const yearData = csvdata.filter(row => row.date.startsWith(year))
      const sortedYearData = yearData.sort((a, b) => b.date.localeCompare(a.date));
      return sortedYearData.length > 0 ? sortedYearData[sortedYearData.length - 1]['date'] : null;
    }

    function getLastTradingDay(year) {
      const startDate = `${year}-01-01`
      const endDate = `${year}-12-31`;
      const yearData = csvdata.filter(row => row.date >= startDate && row.date <= endDate);
      const sortedYearData = yearData.sort((a, b) => b.date.localeCompare(a.date));
      return sortedYearData.length > 0 ? sortedYearData[0]['date'] : null;
    }

    document.getElementById("strategy_select").addEventListener('change', function (e) {
      const strategyNum = +e.target.value;
      const year = document.getElementById("year_select").value;
      plotStrategy(strategyNum, year);
    })

    document.getElementById("year_select").addEventListener('change', function (e) {
      const year = e.target.value;
      const strategyNum = document.getElementById("strategy_select").value;
      plotStrategy(strategyNum, year);
    });

  </script>
</body>

</html>