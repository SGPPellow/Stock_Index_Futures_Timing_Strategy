<!DOCTYPE html>
<html>

<head>
  <title>股指择时策略</title>
  <script src="https://cdn.plot.ly/plotly-3.1.0-rc.1.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    select {
      padding: 8px 8px;
      font-size: 18px;
      font-family: '"Heiti SC"';
      border-radius: 4px;
      background-color: rgb(255, 254, 254);
      color: #000000;
      cursor: pointer;
      outline: none;
      transition: all 0.3s ease;
      width: auto;
      margin-left: 15px;
    }


    #plot {
      width: 2500px;
      height: 1100px;
      margin: 0 0 0 0;
      padding: 10px;
      border-radius: 16px;
    }

    #metricsTableContainer table {
      width: 100%;
      /* 👈 take up full page width */
      border-collapse: collapse;
      font-size: 20px;
    }

    #metricsTableContainer th,
    #metricsTableContainer td {
      /* 👈 space inside cells */
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <!-- <input type="file" id="fileInput" accept=".csv" /> -->
  <h2 style="font-family: Heiti SC; margin-left: 15px; color: #2b2a2a;">股指择时策略</h2>
  <select id="strategy_select">
    <option value="5">多维动量复合风格择时对冲信号</option>
    <option value="1">动量因子风格择时信号</option>
    <option value="2">拥挤度动量因子风格择时信号</option>
    <option value="3">相对强弱动量因子风格择时信号(大盘价值指数和小盘成长指数)</option>
    <option value="4">相对强弱动量因子风格择时信号(沪深300指数和中证1000指数)</option>
  </select>

  <select id="year_select">
    <option value="2025">2025</option>
    <option value="All">All</option>
    <option value="2010">2010</option>
    <option value="2011">2011</option>
    <option value="2012">2012</option>
    <option value="2013">2013</option>
    <option value="2014">2014</option>
    <option value="2015">2015</option>
    <option value="2016">2016</option>
    <option value="2017">2017</option>
    <option value="2018">2018</option>
    <option value="2019">2019</option>
    <option value="2020">2020</option>
    <option value="2021">2021</option>
    <option value="2022">2022</option>
    <option value="2023">2023</option>
    <option value="2024">2024</option>

  </select>
  <select id="page_select">
    <option value="资金曲线">资金曲线</option>
    <option value="每日信号">每日信号</option>
  </select>
  <div id=display>
    <div id="metricsTableContainer" style="border-collapse: collapse;
      background-color: white;
      width: 100%; "></div>
    <div id="plot"></div>
  </div>

  <script>
    let csvdata = [];
    let strategyNum;
    let year;
    let page;
    let sampleData;

    d3.json("/data").then(function (data) {
      csvdata = data;
      updatePage();
    });

    function updatePage() {
      strategyNum = +strategy_select.value;
      year = year_select.value;
      page = page_select.value;

      if (year === 'All') {
        sampleData = csvdata;
      } else {
        sampleData = csvdata.filter(row => row.date.startsWith(year));
      }

      let c1 = 500000, c2 = 500000, c3 = 500000, c4 = 500000, c5 = 500000;
      console.log(sampleData)
      sampleData.forEach((d, i) => {
        c1 = (d.Signal1_day_rtn == null || c1 == null) ? null : c1 * d.Signal1_day_rtn;
        c2 = (d.Signal2_day_rtn == null || c2 == null) ? null : c2 * d.Signal2_day_rtn;
        c3 = (d.Signal3_day_rtn == null || c3 == null) ? null : c3 * d.Signal3_day_rtn;
        c4 = (d.Signal4_day_rtn == null || c4 == null) ? null : c4 * d.Signal4_day_rtn;
        c5 = (d.Signal5_day_rtn == null || c5 == null) ? null : c5 * d.Signal5_day_rtn;

        d.Signal1_cum_value = c1;
        d.Signal2_cum_value = c2;
        d.Signal3_cum_value = c3;
        d.Signal4_cum_value = c4;
        d.Signal5_cum_value = c5;
      });

      if (page === "资金曲线") {

        sampleData = sampleData.slice(0, -1);
        calculatePerformanceMetrics(strategyNum, year);
        plotStrategy(strategyNum, year);

      } else if (page === "每日信号") {
        document.getElementById('plot').innerHTML = `<div id="metricsTableContainer"></div>`;
        const column_name = ['日期', '持仓', '当日收益率', '累计资金']
        const selectedColumns = ["date", `Position${strategyNum}`, `Signal${strategyNum}_day_rtn`, `Signal${strategyNum}_cum_value`];
        const container = d3.select("#metricsTableContainer");
        container.html("");

        const tableWrapper = container.append("div")
          .style("max-height", "900px")   // 👈 limit height
          .style("overflow-y", "auto")    // 👈 vertical scrollbar
          .style("display", "block")       // ensure block-level
          .style("border", "1px solid #ccc");

        const table = tableWrapper.append("table")
          .style("border-collapse", "collapse")
          .style("width", "100%")
          .style("font-family", "Arial, sans-serif")
          .style("font-size", "14px")
          .style("text-align", "center")
          .style("border", "1px solid #ddd")
          .style("box-shadow", "0 2px 5px rgba(0,0,0,0.1)")
          .style("background-color", "#fdfdfd");

        table.append("thead").append("tr")
          .selectAll("th")
          .data(column_name)
          .enter()
          .append("th")
          .text(d => d)
          .style("padding", "10px 12px")
          .style("border-bottom", "2px solid ")
          .style("background-color", "#f2f2f2")
          .style("color", "#333")
          .style("font-weight", "bold")
          .style("position", "sticky")  // optional: sticky header
          .style("top", "0")
          .style("z-index", "1");

        const rows = table.append("tbody")
          .selectAll("tr")
          .data([...sampleData].reverse())
          .enter()
          .append("tr");

        rows.selectAll("td")
          .data((d) => selectedColumns.map(col => {
            if (col == `Signal${strategyNum}_day_rtn`) {
              return d[col] != null ? d[col].toFixed(6) : "";
            } else if (col == `Signal${strategyNum}_cum_value`) {
              return d[col] != null ? Math.round(d[col]) : ""; // round and handle null
            }
            return d[col]; // otherwise display as-is
          }))
          .enter()
          .append("td")
          .text(d => d)
          .style("border", "1px solid black")
          .style("padding", "4px");
      }
    }

    function plotStrategy(n, year) {

      const x = sampleData.map(row => row.date);
      const y = sampleData.map(row => +row[`Signal${n}_cum_value`])
      const position = sampleData.map(row => row[`Position${n}`])

      const trace = {
        x: x,
        y: y,
        mode: 'lines',
        name: '',
        text: position,
        line: {
          color: '#0077B6',
          width: 6
        },
        hovertemplate: '<b>Date</b>: %{x|%Y-%m-%d}<br>' + '<b>Value</b>: %{y}<br>' + '<b>Position</b>: %{text}'
      }

      const layout = {
        title: { text: '' },
        xaxis: {
          type: 'date'
        },
        xaxis: {
          type: 'date'
        },
        yaxis: {
          tickformat: ",.0f"
        },
        hoverlabel: {
          align: 'left',
          font: {
            size: 18,
          }
        },
        height: window.innerHeight * 0.7,
        margin: {
          t: 20,  // top
          r: 20,  // right
          l: 50,  // left (keep enough for y-axis labels)
          b: 20   // bottom (enough for x-axis labels)
        }

      };

      Plotly.newPlot('plot', [trace], layout);

    }

    function calculatePerformanceMetrics(n, year) {

      var startValue = 500000;
      var startDate;

      startDate = sampleData[0]['date'];
      var endDate = sampleData[sampleData.length - 1]['date'];
      var endValue = sampleData[sampleData.length - 1][[`Signal${n}_cum_value`]]
      var returnPercentage = ((endValue - startValue) / startValue) * 100;
      var annualReturn = ((endValue / startValue) ** (250 / sampleData.length) - 1) * 100;
      let peak = startValue;
      var peakTime = 0;
      var allPeakTime = 0;
      var allLowTime = 0;
      let maxDrawdown = 0;

      for (let i = 1; i < sampleData.length; i++) {
        if (sampleData[i][`Signal${n}_cum_value`] > peak) {
          peak = sampleData[i][`Signal${n}_cum_value`];
          peakTime = sampleData[i]['date'];
        } else {
          const drawdown = (peak - sampleData[i][`Signal${n}_cum_value`]) / peak * 100;
          if (drawdown > maxDrawdown) {
            maxDrawdown = drawdown;
            allPeakTime = peakTime;
            allLowTime = sampleData[i]['date'];
          }
        }
      }

      let tableHTML;
      if (year === 'All') {
        tableHTML = `
          <table>
            <tbody>
              <tr>
                <td style="padding: 10px; padding-right: 60px;"><b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}</td>
                <td style="padding: 10px; padding-right: 60px;"><b>期初资金</b>:&nbsp&nbsp${startValue.toFixed(0)}</td>
                <td style="padding: 10px; padding-right: 60px;"><b>期末资金</b>:&nbsp&nbsp${endValue.toFixed(0)}</td>
                <td style="padding: 10px; padding-right: 60px;"><b>净资金变动</b>:&nbsp&nbsp${(endValue - startValue).toFixed(0)} </td>
              </tr>
              <tr>
                <td style="padding: 10px;"><b>累计收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%</td>  
                <td style="padding: 10px;"><b>年化收益率</b>:&nbsp&nbsp${annualReturn.toFixed(2)}%</td>
                <td style="padding: 10px;"><b>最大回撤</b>:&nbsp&nbsp${maxDrawdown.toFixed(2)}%</td>
                <td style="padding: 10px;"><b>最大回撤发生时间</b>:&nbsp&nbsp${allPeakTime} ~ ${allLowTime}</td>
              </tr>
            </tbody>
          </table>
        `;
      } else {
        tableHTML = `
          <table>
            <tbody>
              <tr>
                <td style="padding: 10px;"><b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}</td>
                <td style="padding: 10px;"><b>期初资金</b>:&nbsp&nbsp${startValue.toFixed(0)}</td>
                <td style="padding: 10px;"><b>期末资金</b>:&nbsp&nbsp${endValue.toFixed(0)}</td>
                <td style="padding: 10px;"><b>净资金变动</b>:&nbsp&nbsp${(endValue - startValue).toFixed(0)} </td>
              </tr>
              <tr> 
                <td style="padding: 10px;"><b>年化收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%</td>
                <td style="padding: 10px;"><b>最大回撤</b>:&nbsp&nbsp${maxDrawdown.toFixed(2)}%</td>
                <td style="padding: 10px;"><b>最大回撤发生时间</b>:&nbsp&nbsp${allPeakTime} ~ ${allLowTime}</td>
              </tr>
            </tbody>
          </table>
        `;
      }

      document.getElementById('metricsTableContainer').innerHTML = tableHTML;
    }

    strategy_select.addEventListener('change', updatePage);
    year_select.addEventListener('change', updatePage);
    page_select.addEventListener('change', updatePage);

  </script>
</body>

</html>