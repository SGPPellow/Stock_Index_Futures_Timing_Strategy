<!DOCTYPE html>
<html>

<head>
  <title>股指择时策略</title>
  <script src="https://cdn.plot.ly/plotly-3.1.0-rc.1.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Container style for centering */

    /* Style for the select element */
    select {
      padding: 12px 20px;
      font-size: 18px;
      font-family: 'system-ui';
      /* border: 2px solid #45c6a8; */
      border-radius: 8px;
      background-color: white;
      color: #333;
      cursor: pointer;
      outline: none;
      transition: all 0.3s ease;
      width: auto;
      margin-left: 15px;
    }

    /* Focused (active) state for select */
    select:focus {
      border-color: #1f77b4;
      box-shadow: 0 0 8px rgba(52, 178, 161, 0.5);
    }

    /* Hover effect */
    select:hover {
      border-color: #1f77b4;
    }

    #plot {
      width: 2500px;
      height: 1000px;
      /* or any fixed width you like */
      margin: 0 0 0 0;
      /* top, right, bottom, left */
      padding: 10px;
      border-radius: 16px;
      background-color: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #space1 {
      display: inline-block;
      width: 4em;
    }

    #space2 {
      display: inline-block;
      width: 9.5em;
    }
  </style>
</head>

<body>
  <!-- <input type="file" id="fileInput" accept=".csv" /> -->
  <h2 style="font-family: system-ui; margin-left: 15px;">股指择时策略</h2>
  <select id="strategy_select">
    <option value="1">动量因子风格择时信号</option>
    <option value="2">拥挤度动量因子风格择时信号</option>
    <option value="3">相对强弱动量因子风格择时信号(大盘价值指数和小盘成长指数)</option>
    <option value="4">相对强弱动量因子风格择时信号(沪深300指数和中证1000指数)</option>
    <option value="5">多维动量复合风格择时对冲信号</option>
  </select>

  <select id="year_select">
    <option value="All">All</option>
    <option value="2010">2010</option>
    <option value="2011">2011</option>
    <option value="2012">2012</option>
    <option value="2013">2013</option>
    <option value="2014">2014</option>
    <option value="2015">2015</option>
    <option value="2016">2016</option>
    <option value="2017">2017</option>
    <option value="2018">2018</option>
    <option value="2019">2019</option>
    <option value="2020">2020</option>
    <option value="2021">2021</option>
    <option value="2022">2022</option>
    <option value="2023">2023</option>
    <option value="2024">2024</option>
    <option value="2025">2025</option>
  </select>
  <div id="plot">
    <div id="return"
      style="position: absolute; top: 140px; left: 10px; background-color: rgba(255, 255, 255, 0.7); padding: 5px 10px; font-size: 20px; color: #333; border-radius: 5px;">
    </div>
    <div id="max_Drawdown"
      style="position: absolute; top: 180px; left: 10px; background-color: rgba(255, 255, 255, 0.7); padding: 5px 10px; font-size: 20px; color: #333; border-radius: 5px;">
    </div>
    <div id="metricsTableContainer" style="position: absolute; top: 140px; left: 15px; z-index: 10;"></div>
  </div>

  <script>
    let csvdata = [];
    // document.getElementById("fileInput").addEventListener("change", function (event) {
    //   const file = event.target.files[0];  // Get the first file selected
    //   if (file) {
    //     const reader = new FileReader();  // Create a new FileReader
    //     reader.onload = function (e) {
    //       const csvdata = e.target.result;  // Get the file content as text
    //       // console.log("Raw CSV Data:", csvdata)
    //       csvdata = d3.csvParse(csvdata);  // Parse CSV using D3
    //       console.log("Parsed Data:", csvdata);
    //       plotStrategy(1, 'All');
    //     };
    //     reader.readAsText(file);  // Read the file as text
    //   }
    // });


    d3.csv("https://raw.githubusercontent.com/SGPPellow/Stock_Index_Futures_Timing_Strategy/refs/heads/main/output.csv")
      .then(function (data) {
        csvdata = data;
        plotStrategy(1, 'All');
      })

    function plotStrategy(n, year) {

      calculatePerformanceMetrics(n, year);

      const filteredData = year === 'All'
        ? csvdata // Use all data
        : csvdata.filter(row => row.date.startsWith(year));
      const x = filteredData.map(row => row.date)
      const y = filteredData.map(row => +row[`Signal${n}_Value`])
      const position = filteredData.map(row => row[`Position${n}`])

      const trace = {
        x: x,
        y: y,
        mode: 'lines',
        name: '',
        text: position,
        line: {
          color: '#1f77b4',  // <-- this controls the line color
          width: 2
        },
        hovertemplate: '<b>Date</b>: %{x|%Y-%m-%d}<br>' + '<b>Value</b>: %{y}<br>' + '<b>Position</b>: %{text}'
      }

      const layout = {
        title: { text: '' },
        xaxis: {
          type: 'date'
        },
        xaxis: {
          type: 'date'
        },
        yaxis: {
          tickformat: ",.0f"
        },
        hoverlabel: {
          align: 'left',  // force left-aligned text
          font: {
            size: 18,
          }
        }
      };

      Plotly.newPlot('plot', [trace], layout);

    }

    function calculatePerformanceMetrics(n, year) {
      var startValue;
      var sampleData;
      if (year === 'All') {
        sampleData = csvdata;
        startValue = 500000;
        startDate = sampleData[0]['date'];

      } else if (year === '2010') {
        sampleData = csvdata.filter(row => row.date.startsWith(year));
        startValue = 500000;
        startDate = sampleData[0]['date'];
      } else {
        lastDayOfPreviousYear = getLastTradingDay(year - 1);
        lastDayOfCurrentYear = getLastTradingDay(year);
        sampleData = csvdata.filter(row => row.date >= lastDayOfPreviousYear && row.date <= lastDayOfCurrentYear);
        startValue = sampleData[0][[`Signal${n}_Value`]]
        startDate = getFirstTradingDay(year);
      }

      var endDate = sampleData[sampleData.length - 1]['date'];
      var endValue = sampleData[sampleData.length - 1][[`Signal${n}_Value`]]
      var returnPercentage = ((endValue - startValue) / startValue) * 100;
      var annualReturn = ((endValue / startValue) ** (250 / sampleData.length) - 1) * 100;
      let peak = startValue;
      var peakTime;
      var allPeakTime;
      var allLowTime;
      let maxDrawdown = 0;

      for (let i = 1; i < sampleData.length; i++) {
        if (sampleData[i][`Signal${n}_Value`] > peak) {
          peak = sampleData[i][`Signal${n}_Value`];
          peakTime = sampleData[i]['date'];
        } else {
          const drawdown = (peak - sampleData[i][`Signal${n}_Value`]) / peak * 100;
          if (drawdown > maxDrawdown) {
            maxDrawdown = drawdown;
            allPeakTime = peakTime;
            allLowTime = sampleData[i]['date'];
          }
        }
      }

      let tableHTML;
      if (year === 'All') {
        tableHTML = `
          <table style=" border-collapse: collapse; background-color: white; font-size: 20px;">
            <tbody>
              <tr>
                <td style="padding: 10px;"><b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}</td>
                <td style="padding: 10px;"><b>收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%</td>  
                <td style="padding: 10px;"><b>年化收益率</b>:&nbsp&nbsp${annualReturn.toFixed(2)}%</td>
              </tr>
              <tr>
                <td style="padding: 10px;"><b>最大回撤</b>:&nbsp&nbsp${maxDrawdown.toFixed(2)}%</td>
                <td style="padding: 10px;"><b>最大回撤发生时间</b>:&nbsp&nbsp${allPeakTime} ~ ${allLowTime}</td>
              </tr>
            </tbody>
          </table>
        `;
      } else {
        tableHTML = `
          <table style=" border-collapse: collapse; background-color: white; font-size: 20px;">
            <tbody>
              <tr>
                <td style="padding: 10px;"><b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}</td>
                <td style="padding: 10px;"><b>收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%</td>  
              </tr>
              <tr>
                <td style="padding: 10px;"><b>最大回撤</b>:&nbsp&nbsp${maxDrawdown.toFixed(2)}%</td>
                <td style="padding: 10px;"><b>最大回撤发生时间</b>:&nbsp&nbsp${allPeakTime} ~ ${allLowTime}</td>
              </tr>
            </tbody>
          </table>
        `;
      }

      document.getElementById('metricsTableContainer').innerHTML = tableHTML;
      // if (year === 'All') {
      //   document.getElementById('return').innerHTML = `<b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}<span id="space1"></span><b>收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%<span id="space2"></span><b>年化收益率</b>:&nbsp&nbsp${annualReturn.toFixed(2)}%`;
      // } else {
      //   document.getElementById('return').innerHTML = `<b>时间</b>:&nbsp&nbsp${startDate} ~ ${endDate}<span id="space1"></span><b>收益率</b>:&nbsp&nbsp${returnPercentage.toFixed(2)}%`;
      // }
      // document.getElementById('max_Drawdown').innerHTML = `<b>最大回撤</b>: &nbsp&nbsp${maxDrawdown.toFixed(2)}%<span id="space2"></span><b>最大回撤发生时间:</b>&nbsp&nbsp${allPeakTime} ~ ${allLowTime}`;
    }

    function getFirstTradingDay(year) {
      const yearData = csvdata.filter(row => row.date.startsWith(year))
      const sortedYearData = yearData.sort((a, b) => b.date.localeCompare(a.date));
      return sortedYearData.length > 0 ? sortedYearData[sortedYearData.length - 1]['date'] : null;
    }

    function getLastTradingDay(year) {
      const startDate = `${year}-01-01`
      const endDate = `${year}-12-31`;
      const yearData = csvdata.filter(row => row.date >= startDate && row.date <= endDate);
      const sortedYearData = yearData.sort((a, b) => b.date.localeCompare(a.date));
      return sortedYearData.length > 0 ? sortedYearData[0]['date'] : null;
    }

    document.getElementById("strategy_select").addEventListener('change', function (e) {
      const strategyNum = +e.target.value;
      const year = document.getElementById("year_select").value;
      plotStrategy(strategyNum, year);
    })

    document.getElementById("year_select").addEventListener('change', function (e) {
      const year = e.target.value;
      const strategyNum = document.getElementById("strategy_select").value;
      plotStrategy(strategyNum, year);
    });

  </script>
</body>

</html>